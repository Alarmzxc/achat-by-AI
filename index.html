<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LeanCloud 安全聊天室</title>
<style>
body { font-family: Arial, sans-serif; background: #f3f6fb; margin: 0; padding: 0; }
.container { max-width: 1100px; margin: auto; padding: 20px; }
header { text-align: center; margin-bottom: 10px; }
h1 { color: #1877f2; margin: 0; }
section { background: #fff; border-radius: 8px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
label { display: block; margin-top: 8px; }
input[type="text"], input[type="password"] { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
button { background: #1877f2; color: white; border: none; padding: 8px 16px; margin-top: 10px; border-radius: 4px; cursor: pointer; }
button:disabled { background: #aaa; }
#messages { border: 1px solid #ddd; border-radius: 4px; padding: 10px; height: 300px; overflow-y: auto; background: #fafafa; }
.message { margin-bottom: 8px; }
.msg-self { text-align: right; }
.msg-bubble { display: inline-block; padding: 6px 10px; border-radius: 6px; background: #fff; }
.msg-self .msg-bubble { background: #DCFCE7; }
.room-item { padding: 6px; border-bottom: 1px solid #eee; cursor: pointer; }
.room-item:hover { background: #f5f5f5; }
</style>
</head>
<body>
<div class="container">
<header>
  <h1>LeanCloud 聊天室</h1>
  <p>基于云引擎的安全聊天室示例</p>
</header>

<section id="auth-section">
  <h3>用户认证</h3>
  <div>
    <label>用户名</label>
    <input type="text" id="login-username">
    <label>密码</label>
    <input type="password" id="login-password">
    <button id="login-btn">登录</button>
    <button id="register-btn">注册</button>
    <button id="logout-btn" style="display:none;">登出</button>
    <p>当前用户：<span id="current-user"></span></p>
  </div>
</section>

<section id="room-section" style="display:none;">
  <h3>房间管理</h3>
  <label>房间名称</label>
  <input type="text" id="room-name">
  <label>邀请码（可选）</label>
  <input type="text" id="invitation-code">
  <label><input type="checkbox" id="is-public"> 公开聊天室</label>
  <button id="create-room-btn">创建聊天室</button>

  <h4>加入聊天室</h4>
  <label>邀请码</label>
  <input type="text" id="join-code">
  <button id="join-room-btn">加入</button>

  <h4>公开聊天室</h4>
  <div id="public-rooms"></div>
</section>

<section id="chat-section" style="display:none;">
  <h3 id="chat-title">聊天室</h3>
  <div id="messages"></div>
  <input type="text" id="message-input" placeholder="输入消息...">
  <button id="send-btn">发送</button>
</section>
</div>

<script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leancloud-realtime/dist/realtime-min.js"></script>
<script>
// 配置
const APP_ID = '你的AppID';
const APP_KEY = '你的AppKey';
const SERVER_URL = 'https://你的域名.api.lncldglobal.com';
AV.init({ appId: APP_ID, appKey: APP_KEY, serverURLs: SERVER_URL });
const Realtime = AV.Realtime;

// DOM
const loginBtn = document.getElementById('login-btn');
const registerBtn = document.getElementById('register-btn');
const logoutBtn = document.getElementById('logout-btn');
const currentUserSpan = document.getElementById('current-user');
const roomSection = document.getElementById('room-section');
const chatSection = document.getElementById('chat-section');
const messagesDiv = document.getElementById('messages');
const publicRoomsDiv = document.getElementById('public-rooms');
let realtimeClient = null;
let currentConversation = null;

// 登录
loginBtn.onclick = async () => {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  try {
    await AV.User.logIn(username, password);
    afterLogin();
  } catch(e) { alert('登录失败: ' + e.message); }
};
// 注册
registerBtn.onclick = async () => {
  const username = document.getElementById('login-username').value;
  const password = document.getElementById('login-password').value;
  const user = new AV.User();
  user.setUsername(username);
  user.setPassword(password);
  try { await user.signUp(); alert('注册成功，请登录'); } 
  catch(e) { alert('注册失败: ' + e.message); }
};
// 登出
logoutBtn.onclick = async () => {
  await AV.User.logOut();
  currentUserSpan.textContent = '';
  logoutBtn.style.display = 'none';
  roomSection.style.display = 'none';
  chatSection.style.display = 'none';
};

// 登录后初始化
async function afterLogin() {
  const user = AV.User.current();
  currentUserSpan.textContent = user.getUsername();
  logoutBtn.style.display = 'inline-block';
  roomSection.style.display = 'block';
  realtimeClient = await new Realtime({ appId: APP_ID, appKey: APP_KEY }).createIMClient(user.id);
  fetchPublicRooms();
}

// 创建房间
document.getElementById('create-room-btn').onclick = async () => {
  const name = document.getElementById('room-name').value;
  const invitationCode = document.getElementById('invitation-code').value || null;
  const isPublic = document.getElementById('is-public').checked;
  try {
    const res = await AV.Cloud.run('createRoom', { name, invitationCode, isPublic });
    alert('房间创建成功！邀请码：' + res.invitationCode);
    enterConversation(res.conversationId, res.name);
    fetchPublicRooms();
  } catch(e) { alert('创建失败: ' + e.message); }
};

// 加入房间
document.getElementById('join-room-btn').onclick = async () => {
  const code = document.getElementById('join-code').value;
  try {
    const res = await AV.Cloud.run('getRoomByCode', { invitationCode: code });
    if (!res) return alert('未找到房间');
    enterConversation(res.conversationId, res.name);
  } catch(e) { alert('加入失败: ' + e.message); }
};

// 获取公开房间
async function fetchPublicRooms() {
  try {
    const res = await AV.Cloud.run('listPublicRooms', {});
    publicRoomsDiv.innerHTML = '';
    res.forEach(r => {
      const div = document.createElement('div');
      div.className = 'room-item';
      div.textContent = `${r.name} (邀请码: ${r.invitationCode})`;
      div.onclick = () => enterConversation(r.conversationId, r.name);
      publicRoomsDiv.appendChild(div);
    });
  } catch(e) { publicRoomsDiv.textContent = '加载失败'; }
}

// 进入会话
async function enterConversation(cid, name) {
  chatSection.style.display = 'block';
  document.getElementById('chat-title').textContent = name;
  messagesDiv.innerHTML = '';
  currentConversation = await realtimeClient.getConversation(cid);
  currentConversation.on('message', msg => appendMessage(msg.from, msg.text));
  const history = await currentConversation.queryMessages({ limit: 50 });
  history.forEach(m => appendMessage(m.from, m.text));
}

// 发送消息
document.getElementById('send-btn').onclick = async () => {
  const text = document.getElementById('message-input').value.trim();
  if (!text) return;
  await currentConversation.send(new AV.TextMessage(text));
  appendMessage(AV.User.current().id, text);
  document.getElementById('message-input').value = '';
};

// 显示消息
function appendMessage(from, text) {
  const div = document.createElement('div');
  div.className = 'message' + (from === AV.User.current().id ? ' msg-self' : '');
  const bubble = document.createElement('div');
  bubble.className = 'msg-bubble';
  bubble.textContent = (from === AV.User.current().id ? '我：' : from + '：') + text;
  div.appendChild(bubble);
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// 初始化
if (AV.User.current()) afterLogin();
</script>
</body>
</html>
