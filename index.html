<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LeanCloud 聊天室</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #1877f2; text-align: center; }
        input[type="text"], input[type="password"], textarea { width: calc(100% - 22px); padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background-color: #1877f2; color: white; padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-size: 16px; margin: 8px 0; }
        button:hover { background-color: #166fe5; }
        #app { display: none; }
        #chat-area { display: flex; flex-direction: column; height: 500px; border: 1px solid #ddd; border-radius: 6px; margin-top: 20px; }
        #messages { flex-grow: 1; padding: 10px; overflow-y: auto; background: #fafafa; }
        #message-input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        #message-input { flex-grow: 1; margin: 0; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #send-button { margin-left: 10px; width: auto; padding: 8px 16px; }
        .message-item { margin-bottom: 10px; }
        .message-item strong { color: #1877f2; }
        .error-message { color: red; text-align: center; }
        #chat-list, #create-room-form, #join-room-form { margin-top: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px; }
        .room-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .room-item:hover { background: #f9f9f9; }
    </style>
</head>
<body>

    <div class="container">
        <h1>LeanCloud 聊天室</h1>

        <div id="auth-section">
            <h2>用户认证</h2>
            <form id="register-form">
                <input type="text" id="reg-username" placeholder="用户名" required>
                <input type="password" id="reg-password" placeholder="密码" required>
                <button type="submit">注册</button>
            </form>
            <form id="login-form">
                <input type="text" id="login-username" placeholder="用户名" required>
                <input type="password" id="login-password" placeholder="密码" required>
                <button type="submit">登录</button>
            </form>
        </div>

        <div id="app">
            <h2>欢迎您, <span id="current-user"></span></h2>
            <button id="logout-button">登出</button>

            <hr>

            <div id="create-room-form">
                <h3>创建聊天室</h3>
                <form id="create-room">
                    <input type="text" id="room-name" placeholder="聊天室名称" required>
                    <input type="text" id="invitation-code" placeholder="邀请码（可选，不填自动生成）">
                    <label>
                        <input type="checkbox" id="is-public"> 公开聊天室
                    </label>
                    <button type="submit">创建</button>
                </form>
            </div>

            <div id="join-room-form">
                <h3>加入聊天室</h3>
                <form id="join-room">
                    <input type="text" id="join-code" placeholder="输入邀请码" required>
                    <button type="submit">加入</button>
                </form>
            </div>

            <div id="chat-list">
                <h3>公开聊天室</h3>
                <ul id="public-rooms"></ul>
            </div>

            <hr>

            <div id="chat-area">
                <div id="messages"></div>
                <div id="message-input-area">
                    <input type="text" id="message-input" placeholder="输入消息..." disabled>
                    <button id="send-button" disabled>发送</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-realtime/dist/realtime-min.js"></script>

    <script>
// ------------------------------------------
    // 第一步：在这里替换你的 LeanCloud 应用密钥！
    // ------------------------------------------
    const appId = 'YOUR_APP_ID';
    const appKey = 'YOUR_APP_KEY';
    
    // ------------------------------------------
    // 第二步：初始化 LeanCloud SDK
    // ------------------------------------------
    AV.init({
        appId: appId,
        appKey: appKey,
        serverURLs: 'https://' + appId.substring(0, 8).toLowerCase() + '.api.lncldglobal.com'
    });
    const Realtime = AV.Realtime;

    // 全局变量
    let realtimeClient = null;
    let currentConversation = null;

    // DOM 元素
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app');
    const currentUserSpan = document.getElementById('current-user');
    const registerForm = document.getElementById('register-form');
    const loginForm = document.getElementById('login-form');
    const logoutButton = document.getElementById('logout-button');
    const createRoomForm = document.getElementById('create-room');
    const joinRoomForm = document.getElementById('join-room');
    const publicRoomsList = document.getElementById('public-rooms');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    // 禁用所有聊天室操作，直到IM客户端登录成功
    function setChatControlsEnabled(enabled) {
        document.querySelectorAll('#create-room button, #join-room button, .room-item').forEach(el => {
            el.disabled = !enabled;
            if (el.tagName === 'LI') {
                el.style.cursor = enabled ? 'pointer' : 'not-allowed';
                el.style.opacity = enabled ? '1' : '0.5';
            }
        });
        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;
    }

    // 检查用户登录状态，并初始化IM服务
    async function checkLoginStatus() {
        const user = AV.User.current();
        if (user) {
            authSection.style.display = 'none';
            appSection.style.display = 'block';
            currentUserSpan.textContent = user.getUsername();

            setChatControlsEnabled(false); // 登录成功后先禁用操作

            try {
                // 等待IM客户端登录成功
                await initRealtimeClient(user);
                console.log('IM客户端已成功登录，可以进行聊天室操作。');
                setChatControlsEnabled(true); // 启用操作
                await fetchPublicChatRooms();
            } catch (error) {
                console.error('初始化IM客户端失败:', error);
                alert('IM服务登录失败，请检查网络或重试。');
            }

        } else {
            authSection.style.display = 'block';
            appSection.style.display = 'none';
        }
    }

    // ------------------------------------------
    // 用户认证功能
    // ------------------------------------------
    registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = e.target.elements['reg-username'].value;
        const password = e.target.elements['reg-password'].value;
        const user = new AV.User();
        user.setUsername(username);
        user.setPassword(password);
        try {
            await user.signUp();
            alert('注册成功！请登录。');
            e.target.reset();
        } catch (error) {
            alert('注册失败: ' + error.rawMessage);
            console.error('注册失败', error);
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = e.target.elements['login-username'].value;
        const password = e.target.elements['login-password'].value;
        try {
            await AV.User.logIn(username, password);
            alert('登录成功！');
            checkLoginStatus();
        } catch (error) {
            alert('登录失败: ' + error.rawMessage);
            console.error('登录失败', error);
        }
    });

    logoutButton.addEventListener('click', async () => {
        await AV.User.logOut();
        checkLoginStatus();
        // 清理聊天室状态
        realtimeClient = null;
        currentConversation = null;
        messagesDiv.innerHTML = '';
        messageInput.value = '';
        setChatControlsEnabled(false);
    });

    // ------------------------------------------
    // 聊天室管理功能
    // ------------------------------------------
    createRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const roomName = e.target.elements['room-name'].value;
        const customCode = e.target.elements['invitation-code'].value;
        const isPublic = e.target.elements['is-public'].checked;

        const invitationCode = customCode || Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const ChatRoom = AV.Object.extend('ChatRoom');
        const chatRoom = new ChatRoom();
        chatRoom.set('name', roomName);
        chatRoom.set('creator', AV.User.current());
        chatRoom.set('isPublic', isPublic);
        chatRoom.set('invitationCode', invitationCode);

        try {
            const newRoom = await chatRoom.save();
            alert('聊天室创建成功！邀请码为: ' + invitationCode);
            e.target.reset();
            if (isPublic) {
                fetchPublicChatRooms(); // 刷新公开聊天室列表
            }
        } catch (error) {
            alert('创建失败，邀请码可能已存在或发生其他错误: ' + error.rawMessage);
            console.error('创建失败', error);
        }
    });

    joinRoomForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const joinCode = e.target.elements['join-code'].value.toUpperCase();
        const query = new AV.Query('ChatRoom');
        query.equalTo('invitationCode', joinCode);
        try {
            const chatRoom = await query.first();
            if (chatRoom) {
                enterChatRoom(chatRoom.id);
                alert('已进入聊天室: ' + chatRoom.get('name'));
            } else {
                alert('未找到该邀请码对应的聊天室');
            }
        } catch (error) {
            alert('查询失败: ' + error.rawMessage);
            console.error('查询失败', error);
        }
    });

    async function fetchPublicChatRooms() {
        publicRoomsList.innerHTML = ''; // 清空列表
        const query = new AV.Query('ChatRoom');
        query.equalTo('isPublic', true);
        query.descending('createdAt');
        try {
            const rooms = await query.find();
            rooms.forEach(room => {
                const li = document.createElement('li');
                li.classList.add('room-item');
                li.textContent = room.get('name');
                li.onclick = () => {
                    enterChatRoom(room.id);
                    alert('已进入聊天室: ' + room.get('name'));
                };
                publicRoomsList.appendChild(li);
            });
        } catch (error) {
            console.error('获取公开聊天室失败', error);
        }
    }

    // ------------------------------------------
    // 实时通讯功能
    // ------------------------------------------
    async function initRealtimeClient(user) {
        if (realtimeClient) return; // 防止重复初始化
        try {
            const realtime = new Realtime({ appId: appId, appKey: appKey });
            realtimeClient = await realtime.createIMClient(user.id);
            console.log('IM 客户端登录成功');
        } catch (error) {
            console.error('IM 客户端登录失败', error);
            throw error; // 向上抛出错误，让调用者知道失败了
        }
    }

    async function enterChatRoom(chatRoomId) {
        messagesDiv.innerHTML = ''; // 清空消息区域
        if (!realtimeClient) {
            // 这个判断在优化后应该很少触发，但作为保险仍然保留
            alert('请先登录IM服务');
            return;
        }
        try {
            const conversation = await realtimeClient.getConversation(chatRoomId);
            currentConversation = conversation;
            messageInput.disabled = false;
            sendButton.disabled = false;
            
            // 监听新消息
            currentConversation.on('message', (message, convo) => {
                if (message.from !== AV.User.current().id) {
                    appendMessage(message.from, message.text);
                }
            });

            // 获取历史消息
            const history = await conversation.queryMessages({ limit: 50 });
            history.forEach(msg => {
                appendMessage(msg.from, msg.text);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        } catch (error) {
            alert('进入聊天室失败: ' + error.message);
            console.error('进入聊天室失败', error);
        }
    }

    sendButton.addEventListener('click', async () => {
        const text = messageInput.value.trim();
        if (text && currentConversation) {
            const message = new AV.TextMessage(text);
            try {
                await currentConversation.send(message);
                appendMessage(AV.User.current().id, text);
                messageInput.value = '';
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                alert('消息发送失败: ' + error.message);
                console.error('消息发送失败', error);
            }
        }
    });

    function appendMessage(from, text) {
        const messageItem = document.createElement('div');
        messageItem.classList.add('message-item');
        const username = from === AV.User.current().id ? '我' : '用户 ' + from.substring(0, 6);
        messageItem.innerHTML = `<strong>${username}:</strong> ${text}`;
        messagesDiv.appendChild(messageItem);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // 初始化
    checkLoginStatus();    
</script>

</body>
</html>