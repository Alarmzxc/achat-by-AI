<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天室 - Cloudflare</title>
    <style>
        :root {
            --primary: #3498db;
            --text: #2c3e50;
            --background: #f0f2f5;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        body { font-family: -apple-system, sans-serif; background: var(--background); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { width: 100%; max-width: 400px; padding: 1rem; }
        .card { background: var(--card-bg); border-radius: 1rem; box-shadow: var(--shadow); padding: 2rem; }
        .card h2 { text-align: center; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group input { width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; box-sizing: border-box; }
        .button { width: 100%; padding: 0.75rem; background-color: var(--primary); color: white; border: none; border-radius: 0.5rem; cursor: pointer; }
        .message { text-align: center; margin-top: 1rem; }

        /* Chat */
        .chat-container { width: 100%; max-width: 900px; height: 90vh; display: flex; background: var(--card-bg); border-radius: 1rem; box-shadow: var(--shadow); }
        .sidebar { width: 250px; border-right: 1px solid var(--border); overflow-y: auto; padding: 1rem; }
        .sidebar h3 { margin-bottom: 1rem; }
        .user-list-item { padding: 0.5rem; cursor: pointer; border-radius: 0.5rem; }
        .user-list-item:hover, .user-list-item.active { background: var(--background); }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 1rem; border-bottom: 1px solid var(--border); text-align: center; }
        .chat-box { flex-grow: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .chat-input { display: flex; padding: 1rem; border-top: 1px solid var(--border); }
        .chat-input input { flex-grow: 1; margin-right: 0.5rem; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; }
        .message-item { background: var(--background); padding: 0.5rem 1rem; border-radius: 1rem; max-width: 70%; }
        .message-item.sent { align-self: flex-end; background: var(--primary); color: white; }
        .message-item.received { align-self: flex-start; }
    </style>
</head>
<body>
    <div id="auth-page" class="container">
        <div class="card">
            <h2>登录 / 注册</h2>
            <form id="auth-form">
                <div class="form-group">
                    <input type="text" id="username" placeholder="用户名" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="密码" required>
                </div>
                <button type="submit" class="button" id="auth-button">登录 / 注册</button>
                <div id="auth-message" class="message"></div>
            </form>
        </div>
    </div>

    <div id="chat-page" class="chat-container" style="display: none;">
        <div class="sidebar">
            <h3>在线用户</h3>
            <div id="user-list"></div>
        </div>
        <div class="chat-main">
            <div class="chat-header">
                <h3 id="chat-room-name">公共聊天室</h3>
            </div>
            <div id="chat-box" class="chat-box"></div>
            <div class="chat-input">
                <input type="text" id="message-input" placeholder="输入消息...">
                <button class="button" id="send-button">发送</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let currentUser = localStorage.getItem('username');
        let currentRoomId = 'public';
        let isChatPage = window.location.hash === '#chat';

        const showMessage = (elementId, msg, isError) => {
            const element = document.getElementById(elementId);
            element.textContent = msg;
            element.style.color = isError ? 'red' : 'green';
        };

        const renderPage = () => {
            document.getElementById('auth-page').style.display = isChatPage ? 'none' : 'flex';
            document.getElementById('chat-page').style.display = isChatPage ? 'flex' : 'none';
        };

        const fetchUsers = async () => {
            const userListDiv = document.getElementById('user-list');
            userListDiv.innerHTML = '';
            const response = await fetch(`${API_URL}/api/users`);
            const users = await response.json();
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = `user-list-item ${user === currentRoomId ? 'active' : ''}`;
                userItem.textContent = user;
                userItem.addEventListener('click', () => switchRoom(user));
                userListDiv.appendChild(userItem);
            });
        };

        const fetchMessages = async () => {
            const chatBox = document.getElementById('chat-box');
            chatBox.innerHTML = '';
            const response = await fetch(`${API_URL}/api/messages?room=${currentRoomId}`);
            const messages = await response.json();
            messages.forEach(msg => {
                const messageItem = document.createElement('div');
                messageItem.className = `message-item ${msg.sender === currentUser ? 'sent' : 'received'}`;
                messageItem.textContent = `${msg.sender}: ${msg.content}`;
                chatBox.appendChild(messageItem);
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        };

        const switchRoom = (room) => {
            currentRoomId = room;
            document.getElementById('chat-room-name').textContent = room === 'public' ? '公共聊天室' : `与 ${room} 的私聊`;
            document.querySelectorAll('.user-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.user-list-item[data-user="${room}"]`)?.classList.add('active');
            fetchMessages();
        };

        if (isChatPage && currentUser) {
            renderPage();
            fetchUsers();
            fetchMessages();
            setInterval(fetchMessages, 1500); // 消息轮询
            setInterval(fetchUsers, 5000); // 用户列表轮询
            window.addEventListener('beforeunload', () => {
                navigator.sendBeacon(`${API_URL}/api/offline`, JSON.stringify({ username: currentUser }));
            });
        } else {
            renderPage();
        }

        // 认证表单提交
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const button = document.getElementById('auth-button');
            button.disabled = true;

            try {
                const response = await fetch(`${API_URL}/api/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                if (response.ok) {
                    localStorage.setItem('username', username);
                    window.location.hash = '#chat';
                    window.location.reload();
                } else {
                    showMessage('auth-message', result.error || '认证失败', true);
                }
            } catch (error) {
                showMessage('auth-message', '网络错误，请稍后重试', true);
            } finally {
                button.disabled = false;
            }
        });

        // 发送消息
        document.getElementById('send-button').addEventListener('click', async () => {
            const input = document.getElementById('message-input');
            const content = input.value;
            if (content.trim() === '') return;

            await fetch(`${API_URL}/api/messages`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    sender: currentUser,
                    receiver: currentRoomId,
                    content
                })
            });

            input.value = '';
            fetchMessages();
        });
    </script>
</body>
</html>